<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The LLM Council</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        .main-container {
            transition: transform 0.3s ease;
            min-height: 100vh;
        }
        .main-container.shifted {
            transform: translateX(300px);
        }
        .sidebar {
            width: 300px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background-color: #1f2937;
            color: #d1d5db;
            padding: 1.5rem;
            padding-top: 4rem;
            transform: translateX(-300px);
            transition: transform 0.3s ease;
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .hamburger-menu {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 20;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #4f46e5;
            transition: transform 0.3s ease, background-color 0.2s;
        }
        .hamburger-menu:hover {
            background-color: #4338ca;
        }
        .hamburger-menu.open {
            transform: translateX(300px);
        }
        .hamburger-menu span {
            display: block;
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 5px 0;
            transition: all 0.3s ease-in-out;
        }
        .hamburger-menu.open span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }
        .hamburger-menu.open span:nth-child(2) {
            opacity: 0;
        }
        .hamburger-menu.open span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }
        .model-config-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: #374151;
            padding: 1rem;
            border-radius: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .model-config-item.draggable {
            cursor: grab;
        }
        .model-config-item.draggable:active {
            cursor: grabbing;
        }
        .model-config-item.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .model-config-item input[type="text"] {
            background-color: #1f2937;
            color: #e0e0e0;
            border: 1px solid #4b5563;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .model-config-item input[type="text"]:focus {
            outline: none;
            border-color: #6366f1;
        }
        .drop-zone {
            min-height: 50px;
            padding: 1rem;
            border: 2px dashed #4b5563;
            border-radius: 0.75rem;
            background-color: #1f2937;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone.drag-over {
            background-color: #374151;
            border-color: #6366f1;
        }
        .response-box {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .prose {
            color: #d1d5db;
        }
        .prose h1, .prose h2, .prose h3, .prose h4 {
            color: #e0e0e0;
            font-weight: bold;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose pre {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
        }
        .prose code {
            font-family: monospace;
            background-color: #1f2937;
            border-radius: 0.25rem;
            padding: 0.2em 0.4em;
        }
        .prose blockquote {
            border-left: 4px solid #6366f1;
            padding-left: 1rem;
            font-style: italic;
            color: #9ca3af;
        }
        .prose ul, .prose ol {
            margin-left: 1.5rem;
            list-style-position: outside;
        }
        .history-item {
            cursor: pointer;
            padding: 0.75rem;
            background-color: #1f2937;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .history-item:hover {
            background-color: #374151;
        }
        .info-button {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #4b5563;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .info-button:hover {
            background-color: #6366f1;
        }
        .tab-button {
            padding: 0.75rem 1rem;
            flex: 1;
            text-align: center;
            font-weight: bold;
            color: #6b7280;
            background-color: #374151;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tab-button.active {
            background-color: #1f2937;
            color: #d1d5db;
        }
        .tab-content {
            padding: 1rem;
        }
        .status-box {
            padding: 1rem;
            background-color: #1f2937;
            border-radius: 1rem;
            border: 1px solid #374151;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            color: #d1d5db;
        }
        .status-icon-loading {
            color: #6366f1;
            animation: spin 1.5s linear infinite;
        }
        .status-icon-success {
            color: #4ade80;
        }
        .status-icon-error {
            color: #f87171;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .collapsible-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #2d3748;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 500px; /* Adjust as needed */
        }
        .collapsible-content.collapsed {
            max-height: 0;
        }
        .collapsible-icon {
            transition: transform 0.3s ease;
        }
        .collapsible-icon.rotated {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center p-4">

    <!-- Hamburger Menu Button -->
    <div id="hamburger-menu" class="hamburger-menu open">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Sidebar / Tabbed Panel -->
    <div id="sidebar" class="sidebar open">
        <div class="flex border-b border-gray-600">
            <button id="setup-tab-button" class="tab-button active">Setup</button>
            <button id="history-tab-button" class="tab-button">History</button>
        </div>
        
        <div id="setup-tab" class="tab-content">
            <h2 class="text-xl font-bold mb-6 text-white">Council Setup</h2>

            <!-- Collapsible Setup Explanation -->
            <div id="setup-explanation-collapsible">
                <div class="collapsible-header">
                    <h3 class="text-lg font-bold text-gray-300">How It Works</h3>
                    <i id="explanation-icon" class="fas fa-chevron-up collapsible-icon text-gray-400"></i>
                </div>
                <div id="setup-explanation-content" class="collapsible-content">
                    <div class="text-sm text-gray-400 mb-6 mt-4">
                        <p class="mb-2">To begin, configure your LLM Council by dragging and dropping models into the appropriate zones below. You'll need to provide an API key for each model you wish to use.</p>
                        <p class="mb-2">Once configured, the council members (including the speaker) will provide their individual responses to your query. The <strong>Speaker</strong> will then synthesize these responses into a single, comprehensive answer.</p>
                        <ul class="list-disc list-inside space-y-1">
                            <li><strong>Speaker:</strong> Select one LLM to act as the council speaker.</li>
                            <li><strong>Council Members:</strong> Choose 2 to 6 LLMs to be council members.</li>
                            <li><strong>Configured Models:</strong> Models with a valid API key will appear here.</li>
                            <li><strong>Unconfigured Models:</strong> Models without an API key will be here. You must provide a key before they can be added to the council.</li>
                        </ul>
                        <p class="mt-4">You can find more details on the project <a class="font-medium text-blue-600 dark:text-blue-500 hover:underline" href="https://github.com/pmmaga/llmcouncil/blob/main/README.md">README</a>.</p>
                    </div>
                </div>
            </div>

            <div id="setup-status" class="mb-4 text-center text-sm font-semibold text-red-400">
                Council setup needed.
            </div>
            <div class="space-y-4">
                <h3 class="text-lg font-bold text-gray-300">Speaker (1)</h3>
                <div id="speaker-zone" class="drop-zone"></div>
                <h3 class="text-lg font-bold text-gray-300">Council Members (2-6)</h3>
                <div id="member-zone" class="drop-zone min-h-[220px]"></div>
                <h3 class="text-lg font-bold text-gray-300">Configured Models</h3>
                <div id="configured-zone" class="drop-zone"></div>
                <h3 class="text-lg font-bold text-gray-300">Unconfigured Models</h3>
                <div id="unconfigured-zone" class="drop-zone"></div>
            </div>
            <div id="save-status" class="mt-4 text-center text-sm font-semibold text-green-500"></div>
        </div>

        <div id="history-tab" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-6 text-white">History</h2>
            <div id="history-list" class="space-y-2">
                <!-- History items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-content" class="main-container shifted flex flex-col items-center justify-center min-h-screen px-4 py-16">
        <div class="max-w-4xl w-full mx-auto p-8 bg-gray-800 rounded-3xl shadow-xl space-y-8">
            <h1 class="text-4xl font-extrabold text-center text-gray-100">The LLM Council</h1>
            <p class="text-center text-gray-400 text-lg">
                Leverage a council of LLMs to generate a comprehensive, synthesized response to your query.
            </p>
            
            <div class="relative">
                <textarea id="prompt-input" rows="4" class="w-full p-4 border border-gray-600 rounded-2xl bg-gray-900 text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors" placeholder="Enter your query here..."></textarea>
                <div class="absolute bottom-4 right-4 flex items-center space-x-2">
                    <button id="send-prompt" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Send
                    </button>
                </div>
            </div>
            
            <!-- Real-time Status Panel -->
            <div id="status-panel-container" class="hidden">
                <div class="collapsible-header">
                    <h3 class="text-lg font-bold text-gray-300">Request Status</h3>
                    <i id="status-icon" class="fas fa-chevron-up collapsible-icon text-gray-400"></i>
                </div>
                <div id="status-panel-content" class="collapsible-content">
                    <div id="status-panel" class="status-box space-y-2 mt-2">
                        <!-- Status items will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Response Container -->
            <div id="response-container" class="space-y-6">
                <!-- LLM responses will be injected here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const saveStatus = document.getElementById('save-status');
            const promptInput = document.getElementById('prompt-input');
            const sendPromptButton = document.getElementById('send-prompt');
            const responseContainer = document.getElementById('response-container');
            const setupStatus = document.getElementById('setup-status');
            const historyList = document.getElementById('history-list');

            const setupTabButton = document.getElementById('setup-tab-button');
            const historyTabButton = document.getElementById('history-tab-button');
            const setupTab = document.getElementById('setup-tab');
            const historyTab = document.getElementById('history-tab');

            const speakerZone = document.getElementById('speaker-zone');
            const memberZone = document.getElementById('member-zone');
            const configuredZone = document.getElementById('configured-zone');
            const unconfiguredZone = document.getElementById('unconfigured-zone');

            // Collapsible elements
            const setupExplanationHeader = document.getElementById('setup-explanation-collapsible').querySelector('.collapsible-header');
            const setupExplanationContent = document.getElementById('setup-explanation-content');
            const setupExplanationIcon = document.getElementById('explanation-icon');
            const statusPanelContainer = document.getElementById('status-panel-container');
            const statusPanelHeader = statusPanelContainer.querySelector('.collapsible-header');
            const statusPanelContent = document.getElementById('status-panel-content');
            const statusPanelIcon = document.getElementById('status-icon');
            const statusPanel = document.getElementById('status-panel');

            // Model definitions with key instructions and refactored API logic
            const allModels = [
                {
                    id: "gemini",
                    name: "Google Gemini (flash)",
                    apiKeyRequired: true,
                    apiUrl: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`,
                    keyInfo: "Get your key from Google AI Studio or the Google Cloud Console.",
                    getPayload: (prompt) => ({ contents: [{ role: "user", parts: [{ text: prompt }] }] }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'X-goog-api-key': apiKey }),
                    getResponseText: (result) => result?.candidates?.[0]?.content?.parts?.[0]?.text
                },
                {
                    id: "openai-gpt",
                    name: "OpenAI GPT-5",
                    apiKeyRequired: true,
                    apiUrl: "https://api.openai.com/v1/responses",
                    keyInfo: "Find your key on the OpenAI API Keys dashboard.",
                    getPayload: (prompt) => ({ "model": "gpt-5", "input": prompt }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                    getResponseText: (result) => result?.choices?.[0]?.message?.content
                },
                {
                    id: "groq-deepseek",
                    name: "Groq DeepSeek",
                    apiKeyRequired: true,
                    apiUrl: "https://api.groq.com/openai/v1/chat/completions",
                    keyInfo: "Get your key from the GroqCloud developer dashboard.",
                    getPayload: (prompt) => ({ "model": "deepseek-r1-distill-llama-70b", "messages": [{ "role": "user", "content": prompt }] }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                    getResponseText: (result) => result?.choices?.[0]?.message?.content
                },
                {
                    id: "mistral-instruct",
                    name: "Mistral Instruct",
                    apiKeyRequired: true,
                    apiUrl: "https://api.mistral.ai/v1/chat/completions",
                    keyInfo: "Find your key in the Mistral AI Console.",
                    getPayload: (prompt) => ({ "model": "mistral-large-latest", "messages": [{ "role": "user", "content": prompt }] }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                    getResponseText: (result) => result?.choices?.[0]?.message?.content
                },
                {
                    id: "llama-3",
                    name: "Meta Llama-3",
                    apiKeyRequired: true,
                    apiUrl: "https://api.groq.com/openai/v1/chat/completions",
                    keyInfo: "Get your key from the GroqCloud developer dashboard. You can use the same key for Groq Mixtral.",
                    getPayload: (prompt) => ({ "model": "llama-3.1-8b-instant", "messages": [{ "role": "user", "content": prompt }] }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                    getResponseText: (result) => result?.choices?.[0]?.message?.content
                },
                {
                    id: "claude-haiku",
                    name: "Anthropic Claude 3 Haiku",
                    apiKeyRequired: true,
                    apiUrl: "https://api.anthropic.com/v1/messages",
                    keyInfo: "Find your key on the Anthropic console.",
                    getPayload: (prompt) => ({ "model": "claude-3-haiku-20240307", "messages": [{ "role": "user", "content": prompt }], "max_tokens": 1024 }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01' }),
                    getResponseText: (result) => result?.content?.[0]?.text
                },
                {
                    id: "cohere",
                    name: "Cohere Command",
                    apiKeyRequired: true,
                    apiUrl: "https://api.cohere.ai/v1/chat",
                    keyInfo: "Get your key from the Cohere dashboard.",
                    getPayload: (prompt) => ({ "model": "command-r", "message": prompt }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                    getResponseText: (result) => result?.text
                },
                {
                    id: "deepseek",
                    name: "DeepSeek Coder",
                    apiKeyRequired: true,
                    apiUrl: "https://api.deepseek.com/v1/chat/completions",
                    keyInfo: "Find your key on the DeepSeek API console.",
                    getPayload: (prompt) => ({ "model": "deepseek-coder", "messages": [{ "role": "user", "content": prompt }] }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                    getResponseText: (result) => result?.choices?.[0]?.message?.content
                },
                {
                    id: "together-llama",
                    name: "Together AI Llama 3",
                    apiKeyRequired: true,
                    apiUrl: "https://api.together.xyz/v1/chat/completions",
                    keyInfo: "Get your key from the Together AI platform.",
                    getPayload: (prompt) => ({ "model": "meta-llama/Llama-3-8b-chat-hf", "messages": [{ "role": "user", "content": prompt }] }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                    getResponseText: (result) => result?.choices?.[0]?.message?.content
                },
                {
                    id: "huggingface",
                    name: "Hugging Face (Inference API)",
                    apiKeyRequired: true,
                    apiUrl: "https://api-inference.huggingface.co/models/",
                    keyInfo: "Find your user token in your Hugging Face profile settings under 'Access Tokens'.",
                    getPayload: (prompt) => ({ "inputs": prompt }),
                    getHeaders: (apiKey) => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }),
                    getResponseText: (result) => result?.[0]?.generated_text
                },
            ];

            let modelConfigurations = {};
            const localStorageKey = 'llmCouncilConfig_v3';
            const historyKey = 'llmCouncilHistory_v3';
            let history = [];
            const MAX_MEMBERS = 6;
            const MIN_MEMBERS = 2;

            // Load from local storage or initialize
            function loadConfig() {
                const savedConfig = localStorage.getItem(localStorageKey);
                let loadedApiKeys = {};
                let raw = {};
                if (savedConfig) {
                    // Only keep keys for models that exist in allModels
                    raw = JSON.parse(savedConfig);
                    loadedApiKeys = Object.keys(raw)
                        .filter(id => allModels.some(m => m.id === id))
                        .reduce((acc, id) => {
                            acc[id] = raw[id].apiKey || "";
                            return acc;
                        }, {});
                }
                // Always build modelConfigurations from allModels, only injecting apiKey and zone if present
                modelConfigurations = allModels.reduce((acc, model) => {
                    acc[model.id] = {
                        ...model,
                        apiKey: loadedApiKeys[model.id] || "",
                        zone: (loadedApiKeys[model.id] && loadedApiKeys[model.id] !== "") ? (raw && raw[model.id]?.zone) || 'configured' : 'unconfigured'
                    };
                    return acc;
                }, {});
            }

            function saveConfig() {
                // Only store apiKey and zone for each model
                const toStore = {};
                Object.values(modelConfigurations).forEach(model => {
                    toStore[model.id] = {
                        apiKey: model.apiKey || "",
                        zone: model.zone || "unconfigured"
                    };
                });
                localStorage.setItem(localStorageKey, JSON.stringify(toStore));
                saveStatus.textContent = "Configuration saved!";
                saveStatus.className = 'mt-4 text-center text-sm font-semibold text-green-500';
                setTimeout(() => {
                    saveStatus.textContent = "";
                }, 2000);
                updateSetupStatus();
            }

            function loadHistory() {
                const savedHistory = localStorage.getItem(historyKey);
                if (savedHistory) {
                    history = JSON.parse(savedHistory);
                    renderHistory();
                }
            }

            function renderHistory() {
                historyList.innerHTML = '';
                if (history.length === 0) {
                    historyList.innerHTML = `<div class="text-center text-gray-500">No history yet.</div>`;
                    return;
                }
                history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.classList.add('history-item', 'text-gray-200');
                    historyItem.textContent = `${index + 1}. ${item.prompt.substring(0, 50)}${item.prompt.length > 50 ? '...' : ''}`;
                    historyItem.addEventListener('click', () => {
                        displayResponse(item.speakerResponse, item.memberResponses, item.speaker, item.councilMembers);
                        // Switch to main content view
                        if (sidebar.classList.contains('open')) {
                            hamburgerMenu.click();
                        }
                    });
                    historyList.appendChild(historyItem);
                });
            }

            function renderModelConfig() {
                speakerZone.innerHTML = '';
                memberZone.innerHTML = '';
                configuredZone.innerHTML = '';
                unconfiguredZone.innerHTML = '';

                allModels.forEach(model => {
                    const config = modelConfigurations[model.id];
                    const modelItem = document.createElement('div');
                    modelItem.classList.add('model-config-item', 'bg-gray-700', 'p-4', 'rounded-xl', 'shadow-md', 'mb-2', 'flex', 'flex-col', 'gap-2');
                    modelItem.dataset.modelId = model.id;

                    const isConfigured = config.apiKey.trim() !== "";
                    if (isConfigured) {
                        modelItem.classList.add('draggable');
                        modelItem.draggable = true;
                    }

                    modelItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-gray-200">${model.name}</span>
                            <button class="info-button">i</button>
                        </div>
                        <div class="key-info-container hidden text-sm bg-gray-600 p-2 rounded-lg text-gray-300">
                            ${model.keyInfo}
                        </div>
                        <input type="text" class="w-full text-sm mt-1" placeholder="Enter API Key" data-model-id="${model.id}" value="${config.apiKey}">
                    `;

                    const apiKeyInput = modelItem.querySelector('input[type="text"]');
                    apiKeyInput.addEventListener('input', (e) => {
                        modelConfigurations[model.id].apiKey = e.target.value;
                        const newZone = (e.target.value.trim() !== "") ? 'configured' : 'unconfigured';
                        modelConfigurations[model.id].zone = newZone;
                        saveConfig();
                        renderModelConfig();
                    });

                    const infoButton = modelItem.querySelector('.info-button');
                    infoButton.addEventListener('click', () => {
                        const infoContainer = modelItem.querySelector('.key-info-container');
                        infoContainer.classList.toggle('hidden');
                    });

                    if (config.zone === 'speaker') {
                        speakerZone.appendChild(modelItem);
                    } else if (config.zone === 'member') {
                        memberZone.appendChild(modelItem);
                    } else if (config.zone === 'configured') {
                        configuredZone.appendChild(modelItem);
                    } else {
                        unconfiguredZone.appendChild(modelItem);
                    }
                });
                updateSetupStatus();
            }

            function updateSetupStatus() {
                const speakerCount = speakerZone.childElementCount;
                const memberCount = memberZone.childElementCount;
                const isSetupComplete = speakerCount === 1 && memberCount >= MIN_MEMBERS && memberCount <= MAX_MEMBERS;

                if (isSetupComplete) {
                    setupStatus.textContent = "Council is ready.";
                    setupStatus.classList.remove('text-red-400');
                    setupStatus.classList.add('text-green-400');
                    sendPromptButton.disabled = false;
                } else {
                    setupStatus.textContent = `Council setup needed. (1 speaker, ${MIN_MEMBERS}-${MAX_MEMBERS} members)`;
                    setupStatus.classList.remove('text-green-400');
                    setupStatus.classList.add('text-red-400');
                    sendPromptButton.disabled = true;
                }
            }

            // --- Collapsible Logic ---
            function setupCollapsible(header, content, icon) {
                header.addEventListener('click', () => {
                    const isCollapsed = content.classList.toggle('collapsed');
                    if (isCollapsed) {
                        content.style.maxHeight = '0';
                        icon.classList.remove('rotated');
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        icon.classList.add('rotated');
                    }
                });
            }

            setupCollapsible(setupExplanationHeader, setupExplanationContent, setupExplanationIcon);
            setupCollapsible(statusPanelHeader, statusPanelContent, statusPanelIcon);

            // --- Tab Switching ---
            setupTabButton.addEventListener('click', () => {
                setupTabButton.classList.add('active');
                historyTabButton.classList.remove('active');
                setupTab.classList.remove('hidden');
                historyTab.classList.add('hidden');
            });
            historyTabButton.addEventListener('click', () => {
                historyTabButton.classList.add('active');
                setupTabButton.classList.remove('active');
                historyTab.classList.remove('hidden');
                setupTab.classList.add('hidden');
            });

            // --- Drag & Drop Event Listeners ---
            function handleDragStart(event) {
                if (!event.target.classList.contains('draggable')) {
                    event.preventDefault();
                    return;
                }
                currentDragModelId = event.target.dataset.modelId;
                event.dataTransfer.setData('text/plain', currentDragModelId);
                event.target.classList.add('dragging');
            }

            function handleDragEnd(event) {
                event.target.classList.remove('dragging');
            }

            function handleDragOver(event) {
                event.preventDefault();
                const dropZone = event.currentTarget;
                dropZone.classList.add('drag-over');
            }

            function handleDragLeave(event) {
                const dropZone = event.currentTarget;
                dropZone.classList.remove('drag-over');
            }

            function handleDrop(event) {
                event.preventDefault();
                const dropZone = event.currentTarget;
                dropZone.classList.remove('drag-over');
                
                const modelId = event.dataTransfer.getData('text/plain');
                const draggedItem = document.querySelector(`.model-config-item[data-model-id="${modelId}"]`);
                
                let targetZone = '';
                if (dropZone.id === 'speaker-zone') {
                    if (dropZone.childElementCount > 0) {
                        const existingItem = dropZone.firstElementChild;
                        configuredZone.appendChild(existingItem);
                    }
                    targetZone = 'speaker';
                } else if (dropZone.id === 'member-zone') {
                    if (dropZone.childElementCount >= MAX_MEMBERS) {
                        const existingItem = dropZone.firstElementChild;
                        configuredZone.appendChild(existingItem);
                    }
                    targetZone = 'member';
                } else if (dropZone.id === 'configured-zone') {
                    targetZone = 'configured';
                } else if (dropZone.id === 'unconfigured-zone') {
                    targetZone = 'unconfigured';
                }

                if (draggedItem) {
                    dropZone.appendChild(draggedItem);
                }

                modelConfigurations[modelId].zone = targetZone;
                saveConfig();
            }
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
            document.addEventListener('dragstart', handleDragStart);
            document.addEventListener('dragend', handleDragEnd);

            // --- Other Event Listeners ---
            hamburgerMenu.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mainContent.classList.toggle('shifted');
                hamburgerMenu.classList.toggle('open');
            });

            // Initial load
            loadConfig();
            loadHistory();
            renderModelConfig();
            setupExplanationContent.style.maxHeight = setupExplanationContent.scrollHeight + 'px';

            // Function to handle API calls with exponential backoff and status updates
            async function callAPI(model, prompt, statusElement) {
                const maxRetries = 5;
                let currentRetry = 0;
                let delay = 1000;
                
                while (currentRetry < maxRetries) {
                    try {
                        statusElement.innerHTML = `<i class="fas fa-spinner fa-spin status-icon-loading"></i> Asking ${model.name}...`;

                        const payload = model.getPayload(prompt);
                        const headers = model.getHeaders(model.apiKey);
                        const finalUrl = model.apiUrl;
                        
                        const response = await fetch(finalUrl, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const result = await response.json();
                        statusElement.innerHTML = `<i class="fas fa-check-circle status-icon-success"></i> ${model.name} answered (Attempt ${currentRetry + 1})`;
                        return model.getResponseText(result) || `Error: Could not parse response from ${model.name}.`;

                    } catch (error) {
                        console.error(`Error with ${model.name} (Attempt ${currentRetry + 1}):`, error);
                        currentRetry++;
                        if (currentRetry < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                        } else {
                            statusElement.innerHTML = `<i class="fas fa-times-circle status-icon-error"></i> ${model.name} failed to answer (Attempt ${currentRetry + 1})`;
                            return `Error: Maximum retries exceeded for ${model.name}.`;
                        }
                    }
                }
                statusElement.innerHTML = `<i class="fas fa-times-circle status-icon-error"></i> ${model.name} failed to answer (Attempt ${currentRetry + 1})`;
                return `Error: Maximum retries exceeded for ${model.name}.`;
            }

            function displayResponse(speakerResponse, memberResponses, speaker, councilMembers) {
                const speakerHtml = marked.parse(speakerResponse);
                
                responseContainer.innerHTML = `
                    <div class="speaker-response-container">
                        <div class="response-box bg-gray-700 p-6 rounded-2xl shadow-sm border border-indigo-600">
                            <h3 class="text-lg font-bold text-indigo-400 mb-2">${speaker.name} (Council Speaker)</h3>
                            <div class="prose max-w-none text-gray-200">
                                ${speakerHtml}
                            </div>
                            <button id="toggle-members" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded-full text-sm font-semibold hover:bg-gray-500 transition-colors">
                                Show Individual Responses
                            </button>
                        </div>
                        <div id="member-responses-container" class="mt-4 space-y-4 hidden">
                            <!-- Individual responses will go here -->
                        </div>
                    </div>
                `;
                
                const memberResponsesContainer = document.getElementById('member-responses-container');
                memberResponses.forEach((response, index) => {
                    const model = councilMembers[index];
                    const memberHtml = marked.parse(response);
                    const responseHTML = `
                        <div class="response-box bg-gray-800 p-6 rounded-2xl shadow-sm">
                            <h4 class="text-base font-bold text-gray-300 mb-2">${model.name}</h4>
                            <div class="prose max-w-none text-gray-400">${memberHtml}</div>
                        </div>
                    `;
                    memberResponsesContainer.innerHTML += responseHTML;
                });

                document.getElementById('toggle-members').addEventListener('click', () => {
                    memberResponsesContainer.classList.toggle('hidden');
                });
            }

            // Send prompt button logic
            sendPromptButton.addEventListener('click', async () => {
                const originalPrompt = promptInput.value;
                if (!originalPrompt.trim()) {
                    responseContainer.innerHTML = `<div class="p-4 bg-yellow-900 text-yellow-300 rounded-lg">Please enter a prompt.</div>`;
                    return;
                }

                const speaker = Object.values(modelConfigurations).find(m => m.zone === 'speaker');
                const memberModels = Object.values(modelConfigurations).filter(m => m.zone === 'member');
                const councilMembers = [speaker, ...memberModels];
                
                if (!speaker || memberModels.length < MIN_MEMBERS || memberModels.length > MAX_MEMBERS) {
                    responseContainer.innerHTML = `<div class="p-4 bg-red-900 text-red-300 rounded-lg">Please complete the council setup first. (1 speaker and ${MIN_MEMBERS}-${MAX_MEMBERS} members)</div>`;
                    return;
                }

                // Show status panel and clear response container
                statusPanelContainer.classList.remove('hidden');
                responseContainer.innerHTML = '';
                statusPanel.innerHTML = '';

                // Add status items for members
                const memberStatusElements = councilMembers.map(model => {
                    const statusItem = document.createElement('div');
                    statusItem.classList.add('status-item');
                    statusPanel.appendChild(statusItem);
                    return statusItem;
                });
                
                // Add status item for speaker
                const speakerStatusElement = document.createElement('div');
                speakerStatusElement.classList.add('status-item');
                statusPanel.appendChild(speakerStatusElement);

                // Call all member APIs and track status
                const memberResponses = await Promise.all(councilMembers.map((model, index) => {
                    return callAPI(model, originalPrompt, memberStatusElements[index]);
                }));

                // Synthesize responses with speaker
                const synthesisPrompt = `You are a council speaker. Your main goal is to provide a single answer based on multiple responses given by different conuncil members. No roleplaying, be objective. The original query was: "${originalPrompt}". The council members have provided the following responses:\n\n${memberResponses.map((r, i) => `Response ${i+1}: ${r}`).join('\n\n')}\n\nSynthesize these responses into a single, comprehensive, and well-structured answer. Highlight any common themes, agreements, or differing viewpoints among the responses. Your synthesized answer should be clear, concise, and directly address the original query.`;
                const speakerResponse = await callAPI(speaker, synthesisPrompt, speakerStatusElement);
                
                // Collapse the status panel after completion
                statusPanelContent.style.maxHeight = '0';
                statusPanelContent.classList.add('collapsed');
                statusPanelIcon.classList.remove('rotated');

                // Save to history
                history.unshift({ prompt: originalPrompt, speakerResponse, memberResponses, speaker, councilMembers: councilMembers });
                localStorage.setItem(historyKey, JSON.stringify(history));
                renderHistory();

                displayResponse(speakerResponse, memberResponses, speaker, councilMembers);
            });
        });
    </script>
    <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
    <script>
        kofiWidgetOverlay.draw('pmmaga', {
            'type': 'floating-chat',
            'floating-chat.donateButton.text': 'Tip Me',
            'floating-chat.donateButton.background-color': 'rgb(79, 70, 229)',
            'floating-chat.donateButton.text-color': '#fff'
        });
    </script>
    <style>
        .floatingchat-container-wrap { left:unset; right: 16px; }
        .floating-chat-kofi-popup-iframe { left:unset; right: 16px; }
    </style>
</body>
</html>
